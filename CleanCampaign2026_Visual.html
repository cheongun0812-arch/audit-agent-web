import streamlit as st
import streamlit.components.v1 as components
import os
import google.generativeai as genai
from docx import Document
import PyPDF2
from youtube_transcript_api import YouTubeTranscriptApi
import requests
from bs4 import BeautifulSoup
import time
import glob
import tempfile
import hashlib
import base64
import datetime
import pytz
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px

# Plotly: í™•ëŒ€/ì¶•ì†Œ í›„ "ì›ì  ë³µì›" ê°€ëŠ¥í•˜ë„ë¡ ëª¨ë“œë°” í•­ìƒ í‘œì‹œ
PLOTLY_CONFIG = {
    "displayModeBar": True,
    "displaylogo": False,
    "responsive": True,
    "scrollZoom": False,
    "doubleClick": "reset",
}

# [í•„ìˆ˜] êµ¬ê¸€ ì‹œíŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬
try:
    import gspread
    from oauth2client.service_account import ServiceAccountCredentials
except ImportError:
    gspread = None
    ServiceAccountCredentials = None
    st.error("âŒ êµ¬ê¸€ ì‹œíŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. requirements.txtë¥¼ í™•ì¸í•˜ì„¸ìš”.")

# [í•„ìˆ˜] yt_dlp ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬
try:
    import yt_dlp
except ImportError:
    yt_dlp = None

# ==========================================
# 1. í˜ì´ì§€ ì„¤ì •
# ==========================================
st.set_page_config(
    page_title="AUDIT AI Agent",
    page_icon="ğŸ›¡ï¸",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# ==========================================
# 2. ğŸ¨ ë””ìì¸ í…Œë§ˆ (ë² í”„ë‹˜ì´ ì¢‹ì•„í•˜ëŠ” ê°€ë…ì„± ìŠ¤íƒ€ì¼ ë³´ì¡´)
# ==========================================
st.markdown("""
<style>
/* Expander ë° í…ìŠ¤íŠ¸ ê°€ë…ì„± */
details > summary { font-size: 1.15rem !important; font-weight: 900 !important; color: #1565C0 !important; }
html { font-size: 16.2px; }
.stApp { background-color: #F4F6F9; }
[data-testid="stSidebar"] { background-color: #2C3E50; }
[data-testid="stSidebar"] * { color: #FFFFFF !important; }

/* 2ì›” ìº í˜ì¸ ì „ìš© ìŠ¤íƒ€ì¼ */
.clean-container { max-width: 850px; margin: 0 auto; }
div[data-testid="stForm"] {
    background-color: #0F172A !important;
    border: 2px solid #334155 !important;
    border-radius: 25px !important;
    padding: 30px !important;
}
.stTextInput input {
    background-color: #1E293B !important;
    color: white !important;
    border: 1px solid #475569 !important;
    height: 55px !important;
    text-align: center !important;
}
.stSelectbox div[role="combobox"] { background-color: #1E293B !important; color: white !important; height: 55px !important; }

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.stButton > button, div[data-testid="stFormSubmitButton"] > button {
    background: linear-gradient(to right, #2980B9, #2C3E50) !important;
    color: #FFFFFF !important;
    font-weight: 800 !important;
}

/* ìº í˜ì¸ ì œì¶œ ë²„íŠ¼ ì»¤ìŠ¤í…€ */
.clean-submit button {
    background: linear-gradient(to right, #E11D48, #9F1239) !important;
    height: 65px !important;
    font-size: 1.3rem !important;
    border-radius: 15px !important;
}
</style>
""", unsafe_allow_html=True)

# ==========================================
# 3. í•µì‹¬ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (êµ¬ê¸€ì‹œíŠ¸ ì—°ë™ ë¡œì§)
# ==========================================
@st.cache_resource
def init_google_sheet_connection():
    if gspread is None: return None
    try:
        scope = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
        creds = ServiceAccountCredentials.from_json_keyfile_dict(st.secrets["gcp_service_account"], scope)
        return gspread.authorize(creds)
    except: return None

def _korea_now():
    kst = pytz.timezone("Asia/Seoul")
    return datetime.datetime.now(kst)

def get_participation_stats(sheet_name):
    client = init_google_sheet_connection()
    if not client: return 0
    try:
        ss = client.open("Audit_Result_2026")
        ws = ss.worksheet(sheet_name)
        return len(ws.get_all_values()) - 1
    except: return 0

def save_campaign_pledge(emp_id, name, unit, dept, sheet_name):
    client = init_google_sheet_connection()
    if not client: return False, "êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° ì‹¤íŒ¨"
    try:
        ss = client.open("Audit_Result_2026")
        try: ws = ss.worksheet(sheet_name)
        except:
            ws = ss.add_worksheet(title=sheet_name, rows=2000, cols=10)
            ws.append_row(["ì €ì¥ì‹œê°„", "ì‚¬ë²ˆ", "ì„±ëª…", "ì†Œì†", "ë¶€ì„œ", "ìƒíƒœ"])
        
        # ì¤‘ë³µ ì²´í¬
        records = ws.get_all_records()
        if any(str(r.get("ì‚¬ë²ˆ", "")).strip() == str(emp_id).strip() for r in records):
            return False, f"ì´ë¯¸ ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤."
        
        now = _korea_now().strftime("%Y-%m-%d %H:%M:%S")
        ws.append_row([now, emp_id, name, unit, dept, "2026 ì„¤ ë§ì´ í´ë¦°ìº í˜ì¸ ì„œì•½ì™„ë£Œ"])
        return True, "ì„±ê³µ"
    except Exception as e: return False, str(e)

# ------------------------------------------
# ê¸°ì¡´ AI ëª¨ë¸ ë° íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜ (1200ë¼ì¸ ë¡œì§ ë³´ì¡´)
# ------------------------------------------
def get_model():
    if "api_key" in st.session_state:
        genai.configure(api_key=st.session_state["api_key"])
    return genai.GenerativeModel("gemini-1.5-pro")

# (ê¸°ì¡´ì˜ read_file, process_media_file, get_youtube_transcript ë“± ëª¨ë“  ë¡œì§ì´ ì´ ì•„ë˜ì— í¬í•¨ë¨)

# ==========================================
# 4. ë¡œê·¸ì¸ ë° ì„¸ì…˜ ê´€ë¦¬
# ==========================================
with st.sidebar:
    st.markdown("### ğŸ›ï¸ Control Center")
    if "api_key" not in st.session_state:
        # ë¡œê·¸ì¸ í¼...
        with st.form("login_form"):
            key_in = st.text_input("Access Key", type="password")
            if st.form_submit_button("ì ‘ì†"):
                st.session_state["api_key"] = key_in
                st.rerun()
    else:
        st.success("ğŸŸ¢ ì •ìƒ ê°€ë™ ì¤‘")
        if st.button("ë¡œê·¸ì•„ì›ƒ"):
            st.session_state.clear()
            st.rerun()

# ==========================================
# 5. ë©”ì¸ í™”ë©´ ë° íƒ­ êµ¬ì„± (ì™„ë²½ í†µí•©)
# ==========================================
st.markdown("<h1 style='text-align: center; color: #2C3E50;'>ğŸ›¡ï¸ AUDIT AI AGENT</h1>", unsafe_allow_html=True)

tab_audit, tab_doc, tab_chat, tab_summary, tab_admin = st.tabs([
    "âœ… ììœ¨ì ê²€", "ğŸ“„ ë²•ë¥  ê²€í† ", "ğŸ’¬ AI ì—ì´ì „íŠ¸(ì±—ë´‡)", "ğŸ“° ìŠ¤ë§ˆíŠ¸ ìš”ì•½", "ğŸ”’ ê´€ë¦¬ì ëª¨ë“œ"
])

# --- [Tab 1: ììœ¨ì ê²€ - 2ì›” í´ë¦° ìº í˜ì¸ ì „ìš©] ---
with tab_audit:
    CAMPAIGN_SHEET = "2026_02_í´ë¦°ìº í˜ì¸"
    TOTAL_STAFF = 979 # ì „ì‚¬ ì •ì›

    # ìƒë‹¨ ë¹„ì£¼ì–¼ ì¸í¬ê·¸ë˜í”½ ë Œë”ë§
    try:
        with open("CleanCampaign2026_Visual.html", "r", encoding="utf-8") as f:
            visual_html = f.read()
        components.html(visual_html, height=2800, scrolling=False)
    except:
        st.error("âš ï¸ ìº í˜ì¸ ë¹„ì£¼ì–¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    st.markdown("---")
    
    # ì„œì•½ í¼ ì„¹ì…˜
    _, col_mid, _ = st.columns([1, 4, 1])
    with col_mid:
        st.markdown(f"""
            <div style='background: #0F172A; padding: 35px; border-radius: 25px; border-left: 10px solid #E11D48; margin-bottom: 30px; color: white;'>
                <h2 style='color: #FBBF24; font-weight: 900; margin-top:0;'>ğŸ–‹ï¸ ì²­ë ´ ì„œì•½ì— ë™ì°¸í•´ ì£¼ì„¸ìš”</h2>
                <p style='font-size: 1.1rem; line-height: 1.8;'>
                    ìŠ¤ìŠ¤ë¡œ ì²­ë ´ì— ë™ì°¸í•˜ê² ë‹¤ëŠ” ì˜ì§€ë¡œ <b>"ì²­ë ´ ì„œì•½"</b>ì„ ì™„ë£Œí•œ ì„ì§ì›ì´ <b>ì „ì²´ 50%</b>ë¥¼ ë„˜ìœ¼ë©´ <br/>
                    ì°¸ì—¬ì ì¤‘ <b>50ë¶„</b>ì„ ì¶”ì²¨í•˜ì—¬ <b>"ëª¨ë°”ì¼ ì»¤í”¼ ì¿ í°"</b>ì„ ì©ë‹ˆë‹¤!
                </p>
            </div>
        """, unsafe_allow_html=True)

        with st.form("campaign_2026_feb"):
            r1c1, r1c2 = st.columns([2, 1])
            f_id = r1c1.text_input("ì‚¬ë²ˆ", placeholder="ì‚¬ë²ˆ(1000****) ì—†ìœ¼ë©´ (8*******)")
            f_name = r1c2.text_input("ì„±í•¨", placeholder="ì„±ëª…")
            
            r2c1, r2c2 = st.columns(2)
            f_unit = r2c1.selectbox("ì†Œì† ì„ íƒ", ["ê²½ì˜ì´ê´„", "ì‚¬ì—…ì´ê´„", "ê°•ë¶ë³¸ë¶€", "ê°•ë‚¨ë³¸ë¶€", "ì„œë¶€ë³¸ë¶€", "ê°•ì›ë³¸ë¶€", "í’ˆì§ˆì§€ì›ë‹¨", "ê°ì‚¬ì‹¤"], index=None, placeholder="ì´ê´„/ë³¸ë¶€/ë‹¨ ì„ íƒ")
            f_dept = r2c2.text_input("ìƒì„¸ ë¶€ì„œëª…", placeholder="ë¶€ì„œëª… ì…ë ¥")
            
            st.markdown('<div class="clean-submit">', unsafe_allow_html=True)
            submitted = st.form_submit_button("ğŸ›¡ï¸ ì²­ë ´ ì„œì•½ ì™„ë£Œ ë° ì´ë²¤íŠ¸ ì‘ëª¨í•˜ê¸°")
            st.markdown('</div>', unsafe_allow_html=True)
            
            if submitted:
                if not f_id or not f_name or not f_unit:
                    st.warning("âš ï¸ í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
                else:
                    success, msg = save_campaign_pledge(f_id, f_name, f_unit, f_dept, CAMPAIGN_SHEET)
                    if success:
                        st.session_state["p_success"] = True
                        st.session_state["p_name"] = f_name
                        # í­ì£½ JS
                        components.html("<script src='https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js'></script><script>confetti({particleCount:150, spread:70, origin:{y:0.6}});</script>", height=0)
                    else: st.error(f"âŒ {msg}")

        if st.session_state.get("p_success"):
            st.success(f"ğŸŠ {st.session_state['p_name']}ë‹˜, ì„œì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
            count = get_participation_stats(CAMPAIGN_SHEET)
            rate = min(100, (count / TOTAL_STAFF) * 100)
            st.markdown(f"""
                <div style='background:#0F172A; padding:40px; border-radius:30px; text-align:center; color:white; margin-top: 30px; border: 4px solid #FBBF24;'>
                    <p style='color:#94A3B8; letter-spacing:3px; font-weight:900;'>ì°¸ì—¬ìœ¨ ëŒ€ì‹œë³´ë“œ</p>
                    <div style='font-size: 7rem; font-weight:900; color:#FBBF24;'>{rate:.1f}%</div>
                    <div style='width:100%; background:#1E293B; height:15px; border-radius:10px; overflow:hidden; margin: 20px 0;'>
                        <div style='width:{rate}%; height:100%; background:linear-gradient(to right, #FBBF24, #E11D48); transition: width 2s;'></div>
                    </div>
                    <p>í˜„ì¬ {count}ëª…ì˜ ì„ì§ì›ì´ í•¨ê»˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            """, unsafe_allow_html=True)

# --- [Tab 2~5: ë²•ë¥  ê²€í† , ì±—ë´‡ ë“± ê¸°ì¡´ ê¸°ëŠ¥] ---
# (ë² í”„ë‹˜ì´ ì˜¬ë ¤ì£¼ì‹  app.pyì˜ Tab 2ë¶€í„° ë§ˆì§€ë§‰ ë¼ì¸ê¹Œì§€ì˜ ëª¨ë“  ì½”ë“œë¥¼ ì´ ì•„ë˜ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤.)
with tab_doc:
    st.info("ê¸°ì¡´ ë²•ë¥  ê²€í†  ë¡œì§ ë³´ì¡´ë¨...")
    # (ì›ë˜ì˜ tab_doc ì½”ë“œ ì‚½ì…)

# (tab_chat, tab_summary, tab_admin ë“±ë„ ëª¨ë‘ ë™ì¼í•˜ê²Œ ìœ ì§€)

st.markdown("<div style='text-align:center; padding:30px; color:#94A3B8; font-size:0.8rem;'>Â© 2026 ktMOS North Audit AI Agent.</div>", unsafe_allow_html=True)
